<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red51 Technology - Tienda Online</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #7B5C7E; /* Purple from Logo */
            --secondary: #1B9AA8; /* Teal from Logo */
            --accent: #10b981;
            --dark: #1a1a2e;
            --light: #f3f4f6; /* Lighter Gray BG */
            --white: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            cursor: pointer;
            user-select: none;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-dark);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .logo-red {
            color: var(--secondary);
        }
        
        .logo-number {
            color: var(--primary);
        }
        
        .logo-subtitle {
            font-size: 0.5em;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dark);
            display: block;
            margin-top: -8px;
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-btn {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .nav-btn:hover {
            color: var(--secondary);
        }
        
        .cart-btn {
            position: relative;
            background: var(--secondary);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .cart-btn:hover {
            transform: translateY(-2px);
            background: #168B97;
            box-shadow: 0 5px 20px rgba(27, 154, 168, 0.3);
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: var(--white);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .hero {
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            color: var(--white);
            padding: 8rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 700px;
        }
        
        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            font-weight: 800;
        }
        
        .hero p {
            font-size: 1.3rem;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        
        .category-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .filter-btn {
            padding: 0.75rem 1.5rem;
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
        
        .products-section {
            margin-bottom: 4rem;
        }
        
        .section-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--primary);
            font-weight: 700;
            text-align: center;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .product-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .product-image {
            width: 100%;
            height: 250px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(239, 68, 68, 0.95);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .product-info {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .product-category {
            color: var(--secondary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .product-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }
        
        .product-brand {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .product-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .product-price {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin-top: auto;
            padding-top: 1rem;
            margin-bottom: 1rem;
        }
        
        .add-to-cart-btn {
            width: 100%;
            background: var(--primary);
            color: var(--white);
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-to-cart-btn:hover {
            transform: translateY(-2px);
            background: var(--secondary);
            box-shadow: 0 5px 20px rgba(27, 154, 168, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            max-width: 800px;
            width: 95%;
            margin: 2rem auto;
            border-radius: 16px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        
        .modal-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-dark);
            line-height: 1;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .cart-item {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .cart-item-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 0.3rem;
        }
        
        .cart-item-brand {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }
        
        .cart-item-variants {
            font-size: 0.85rem;
            color: var(--text-light);
            background-color: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-top: 0.25rem;
        }

        .cart-item-price {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .qty-btn {
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .qty-btn:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .qty-display {
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 30px;
            text-align: center;
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            margin-left: auto;
        }
        
        .cart-total {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--primary);
            color: var(--white);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-total-label {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .cart-total-amount {
            font-size: 2rem;
            font-weight: 800;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .btn-primary {
            width: 100%;
            background: var(--secondary);
            color: var(--white);
            padding: 1.2rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            background: #168B97;
            box-shadow: 0 8px 25px rgba(27, 154, 168, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--primary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .empty-cart {
            text-align: center;
            padding: 3rem 2rem;
            color: #999;
        }
        
        .empty-cart-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .success-icon {
            font-size: 5rem;
            color: var(--success);
            margin-bottom: 1rem;
        }
        
        .success-message h3 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .success-message p {
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        
        .admin-section {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .admin-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-nav-btn {
            padding: 0.75rem 1.5rem;
            background: var(--light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .admin-nav-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }


        .btn-import {
            background: var(--accent);
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-import:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-export {
            background: #6366f1;
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-export:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }

        .image-preview {
            width: 100%;
            max-width: 200px;
            height: 200px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            margin-top: 0.5rem;
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-preview-text {
            font-size: 4rem;
        }

        .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--light);
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--secondary);
            transition: width 0.3s;
        }

        .btn-upload {
            background: var(--accent);
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .btn-upload:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-upload:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .products-table, .categories-table, .pedidos-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .products-table th, .products-table td,
        .categories-table th, .categories-table td,
        .pedidos-table th, .pedidos-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .products-table th, .categories-table th, .pedidos-table th {
            background: var(--light);
            font-weight: 700;
            color: var(--primary);
        }
        
        .products-table tr:hover, .categories-table tr:hover {
            background: #f9fafb;
        }

        .pedidos-table tr:hover {
            background: #f9fafb;
            cursor: pointer;
        }
        
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-edit {
            background: var(--secondary);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }
        
        .footer {
            background: var(--dark);
            color: var(--white);
            text-align: center;
            padding: 2.5rem 2rem;
            margin-top: 4rem;
        }
        
        .footer-logo {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: var(--white);
        }
        
        .login-section {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-info {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary);
        }

        .setup-steps, .sql-code {
             color: var(--text-light); font-size: 0.9rem;
        }

        .setup-steps li {
            margin-bottom: 0.5rem;
        }

        .sql-code {
            background: #eef2ff;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 1rem;
            border: 1px solid #e0e7ff;
            color: #4338ca;
        }
        
        .error-info {
            background: #fff1f2;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--danger);
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .kpi-card-title {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .kpi-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .status-select {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid transparent;
            font-weight: 600;
            color: var(--white);
            text-transform: capitalize;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em;
            padding-right: 2.5em; /* space for the arrow */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            cursor: pointer;
        }

        .status-select:focus {
            outline: 2px solid var(--white);
            outline-offset: -2px;
        }

        .status-select.pendiente_pago { background-color: var(--warning); }
        .status-select.pago_confirmado { background-color: var(--info); }
        .status-select.en_preparacion { background-color: var(--secondary); }
        .status-select.enviado { background-color: var(--primary); }
        .status-select.entregado { background-color: var(--success); }
        .status-select.cancelado { background-color: var(--danger); }

        #mapa {
            height: 450px;
            width: 100%;
            border-radius: 12px;
        }

        .pedidos-table tr.row-updated {
            animation: highlight-row 3s ease-out;
        }

        .variantes-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .variante-group {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .variante-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        .variante-header input {
            flex-grow: 1;
        }
        .opciones-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        .opcion-tag {
            background: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .opcion-tag button {
            background: none; border: none; font-size: 1rem; cursor: pointer; color: var(--danger);
        }
        .opciones-container input {
            border: none;
            padding: 0.5rem;
            background: transparent;
            width: 120px;
        }
        .opciones-container input:focus {
            outline: none;
        }
        #detalleProductoModal .modal-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            max-width: 900px;
        }
        #detalleProductoModal .product-image-modal {
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            border-radius: 16px 0 0 16px;
        }
         #detalleProductoModal .product-image-modal img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes highlight-row {
            0% { background-color: #bfdbfe; }
            100% { background-color: transparent; }
        }
        
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .modal-content {
                margin: 0;
                width: 100%;
                border-radius: 0;
                max-height: 100vh;
            }
            #detalleProductoModal .modal-content {
                grid-template-columns: 1fr;
            }
            #detalleProductoModal .product-image-modal {
                height: 300px;
                 border-radius: 0;
            }
            
            .logo-text {
                font-size: 1.2rem;
            }
            
            .products-table, .categories-table, .pedidos-table {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo-container" onclick="mostrarTienda()">
                <div>
                    <div class="logo-text">
                        <span class="logo-red">Red</span><span class="logo-number">51</span>
                    </div>
                    <span class="logo-subtitle">TECHNOLOGY</span>
                </div>
            </div>
            <div class="nav-links">
                <button class="nav-btn" onclick="mostrarTienda()" id="btnTienda">Tienda</button>
                <button class="nav-btn" onclick="mostrarAdmin()" id="btnAdmin">Admin</button>
                <button class="cart-btn" onclick="abrirCarrito()">
                    Carrito
                    <span class="cart-count" id="cartCount">0</span>
                </button>
            </div>
        </nav>
    </header>

    <div id="tiendaView">
        <section class="hero" id="heroSection">
            <div class="hero-content">
                <h1>Tecnologia de Vanguardia</h1>
                <p>Los mejores productos de tecnologia y electronica con las marcas mas reconocidas del mercado</p>
            </div>
        </section>

        <main class="container">
            <section class="products-section">
                <div class="category-filter" id="categoryFilter"></div>
                <h2 class="section-title">Nuestros Productos</h2>
                <div class="products-grid" id="productsGrid"></div>
                <div id="loadingProducts" class="loading" style="display:none;">Cargando productos...</div>
            </section>
        </main>
    </div>

    <div id="adminView" style="display:none;">
        <main class="container">
            <div id="loginSection" class="login-section">
                <h2 style="margin-bottom: 1rem; color: var(--primary);">Acceso Administrador</h2>
                <div class="auth-info">
                    <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 1rem;">
                        <strong>Para acceder, crea un usuario en Supabase:</strong>
                    </p>
                    <ol class="setup-steps">
                        <li>Ve a tu proyecto Supabase Dashboard ‚Üí Authentication ‚Üí Users</li>
                        <li>Click "Add user" ‚Üí "Create new user"</li>
                        <li>Ingresa email, contrase√±a y confirma el email.</li>
                    </ol>
                </div>
                <form id="loginForm" onsubmit="iniciarSesion(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="emailLogin" required placeholder="admin@red51.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="passwordLogin" required>
                    </div>
                    <button type="submit" class="btn-primary">Iniciar Sesion</button>
                    <div id="loginError" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; background: #fee2e2; color: #b91c1c;"></div>
                </form>
            </div>

            <div id="adminPanel" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <span id="adminEmail" style="color: var(--text-light); font-size: 0.9rem;"></span>
                    <button class="btn-danger" onclick="cerrarSesion()">Cerrar Sesion</button>
                </div>

                <div class="admin-nav">
                    <button class="admin-nav-btn active" id="navBtnPedidos" onclick="mostrarVistaAdmin('pedidos')">Pedidos</button>
                    <button class="admin-nav-btn" id="navBtnProductos" onclick="mostrarVistaAdmin('productos')">Productos</button>
                    <button class="admin-nav-btn" id="navBtnCategorias" onclick="mostrarVistaAdmin('categorias')">Categor√≠as</button>
                    <button class="admin-nav-btn" id="navBtnConfig" onclick="mostrarVistaAdmin('config')">Configuraci√≥n</button>
                    <button class="admin-nav-btn" id="navBtnAyuda" onclick="mostrarVistaAdmin('ayuda')">Ayuda</button>
                </div>

                <div id="pedidosView" class="admin-view-content">
                    <div class="kpi-container">
                        <div class="kpi-card">
                            <div class="kpi-card-title">Ingresos Totales</div>
                            <div class="kpi-card-value" id="kpiIngresos">S/ 0.00</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Pedidos Totales</div>
                            <div class="kpi-card-value" id="kpiTotalPedidos">0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Pedidos Pendientes</div>
                            <div class="kpi-card-value" id="kpiPendientes">0</div>
                        </div>
                    </div>
                     <div class="admin-section">
                        <div class="admin-header">
                            <h2>Historial de Pedidos</h2>
                        </div>
                        <div id="pedidosFilterContainer" class="category-filter"></div>
                        <div style="overflow-x: auto;">
                            <table class="pedidos-table">
                                <thead>
                                    <tr>
                                        <th>N¬∞ Pedido</th>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Ubicaci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="adminPedidosTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="productosView" class="admin-view-content" style="display:none;">
                    <div class="admin-section">
                        <div class="admin-header">
                            <h2>Gestion de Productos</h2>
                            <div class="admin-actions">
                                <button class="btn-export" onclick="descargarPlantilla()">üì• Descargar Plantilla CSV</button>
                                <button class="btn-import" onclick="document.getElementById('importFile').click()">üì§ Importar CSV</button>
                                <input type="file" id="importFile" accept=".csv" style="display:none;" onchange="importarProductos(event)">
                                <button class="btn-secondary" onclick="abrirModalProducto()">+ Agregar Producto</button>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>Imagen</th>
                                        <th>Nombre</th>
                                        <th>Categoria</th>
                                        <th>Precio</th>
                                        <th>Variantes</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="adminProductsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="categoriasView" class="admin-view-content" style="display:none;">
                     <div class="admin-section">
                        <div class="admin-header">
                            <h2>Gesti√≥n de Categor√≠as</h2>
                            <button class="btn-secondary" onclick="abrirModalCategoria()">+ Agregar Categor√≠a</button>
                        </div>
                         <div style="overflow-x: auto;">
                            <table class="categories-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Slug</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="adminCategoriesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="configView" class="admin-view-content" style="display:none;">
                     <div class="admin-section">
                        <div class="admin-header">
                            <h2>Personalizaci√≥n de la Tienda</h2>
                        </div>
                        <form id="configForm" onsubmit="guardarConfiguracion(event)">
                            <div class="form-group">
                                <label for="heroImageUrl">URL de la Imagen Principal (Hero)</label>
                                <input type="url" id="heroImageUrl" placeholder="https://ejemplo.com/imagen.jpg">
                                <div class="form-hint">Pega la URL de la imagen para la secci√≥n principal. Tama√±o recomendado: 1920x1080px.</div>
                            </div>
                            <button type="submit" class="btn-primary" id="btnGuardarConfig">Guardar Cambios</button>
                        </form>
                    </div>
                </div>

                <div id="ayudaView" class="admin-view-content" style="display:none;">
                     <div class="admin-section">
                        <div class="admin-header">
                            <h2>Ayuda y Configuraci√≥n</h2>
                        </div>

                        <div class="auth-info" style="border-left-color: var(--primary); margin-top: 1rem;">
                            <p><strong>Script de Sincronizaci√≥n de Base de Datos (Definitivo)</strong></p>
                            <p class="form-hint" style="margin-top: 0.5rem;">
                                Lamento todos los problemas anteriores. Este error ocurre porque tu tabla de `productos` fue creada con una versi√≥n antigua del script a la que le faltaban columnas como `categoria_id` y `variantes`.
                                <br><br>
                                Este nuevo script es la soluci√≥n final. **Revisa tu tabla `productos` y A√ëADE TODAS las columnas que puedan faltar.** Es un script de "sincronizaci√≥n" que arregla la tabla sin importar qu√© tan antigua sea.
                                <br><br>
                                <strong>Por favor, ejecuta este script completo. Ser√° la √∫ltima vez que necesites hacerlo.</strong>
                            </p>
                            
                            <div class="sql-code" style="max-height: 400px; overflow-y: auto; margin-top: 1.5rem; text-align: left;">
<pre>
-- ========= SCRIPT DE CONFIGURACI√ìN Y SINCRONIZACI√ìN v6 (Definitivo) =========

-- 1. CREACI√ìN DE TABLAS (Si no existen)
CREATE TABLE IF NOT EXISTS public.categorias (
    id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    nombre text NOT NULL,
    slug text NOT NULL UNIQUE,
    created_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.productos (
    id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    nombre text NOT NULL,
    precio numeric NOT NULL DEFAULT 0,
    created_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.pedidos (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    numero_pedido serial NOT NULL,
    fecha_pedido timestamptz DEFAULT now(),
    nombre_cliente text,
    telefono_cliente text,
    email_cliente text,
    direccion text,
    productos jsonb,
    total numeric,
    cantidad_items integer,
    estado text,
    latitud double precision,
    longitud double precision
);

CREATE TABLE IF NOT EXISTS public.configuracion (
    clave text PRIMARY KEY,
    valor text,
    updated_at timestamptz DEFAULT now()
);

-- 2. SINCRONIZACI√ìN DE COLUMNAS (¬°LA SOLUCI√ìN!)
-- Este bloque asegura que TODAS las columnas necesarias existan en la tabla 'productos'.
-- Arregla errores de 'categoria_id', 'variantes', y cualquier otra columna faltante.
ALTER TABLE public.productos
ADD COLUMN IF NOT EXISTS marca text,
ADD COLUMN IF NOT EXISTS descripcion text,
ADD COLUMN IF NOT EXISTS imagen_url text,
ADD COLUMN IF NOT EXISTS icon text,
ADD COLUMN IF NOT EXISTS badge text,
ADD COLUMN IF NOT EXISTS activo boolean DEFAULT true,
ADD COLUMN IF NOT EXISTS variantes jsonb,
ADD COLUMN IF NOT EXISTS categoria_id bigint;


-- 3. RELACI√ìN DE CLAVE EXTERNA
-- Borra la relaci√≥n si ya existe para evitar errores y la vuelve a crear correctamente.
ALTER TABLE public.productos
DROP CONSTRAINT IF EXISTS productos_categoria_id_fkey; 

ALTER TABLE public.productos
ADD CONSTRAINT productos_categoria_id_fkey
FOREIGN KEY (categoria_id)
REFERENCES public.categorias(id)
ON DELETE SET NULL;


-- 4. POL√çTICAS DE ACCESO (Row Level Security - RLS)
ALTER TABLE public.categorias ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.productos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pedidos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.configuracion ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Public read access" ON public.categorias;
CREATE POLICY "Public read access" ON public.categorias FOR SELECT USING (true);

DROP POLICY IF EXISTS "Public read access" ON public.productos;
CREATE POLICY "Public read access" ON public.productos FOR SELECT USING (true);

DROP POLICY IF EXISTS "Public read access" ON public.configuracion;
CREATE POLICY "Public read access" ON public.configuracion FOR SELECT USING (true);

DROP POLICY IF EXISTS "Allow public insert" ON public.pedidos;
CREATE POLICY "Allow public insert" ON public.pedidos FOR INSERT WITH CHECK (true);

DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.categorias;
CREATE POLICY "Allow full access for authenticated users" ON public.categorias FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');

DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.productos;
CREATE POLICY "Allow full access for authenticated users" ON public.productos FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');

DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.pedidos;
CREATE POLICY "Allow full access for authenticated users" ON public.pedidos FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');

DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.configuracion;
CREATE POLICY "Allow full access for authenticated users" ON public.configuracion FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');

-- 5. NOTIFICACI√ìN DE RECARGA DE ESQUEMA
-- Esta l√≠nea le ordena a la API de Supabase que actualice su cach√© inmediatamente.
NOTIFY pgrst_reload_schema;

-- ¬°Configuraci√≥n completada!
</pre>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loadingAdmin" class="loading" style="display:none;">Cargando...</div>
            </div>
        </main>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tu Carrito</h2>
                <button class="close-btn" onclick="cerrarCarrito()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cartContent"></div>
                <div id="successMessage" class="success-message">
                    <div class="success-icon">‚úì</div>
                    <h3>Pedido Realizado con Exito</h3>
                    <p>Hemos recibido tu pedido. Revisa el estado en tu cuenta o contactanos para coordinar la entrega.</p>
                    <button class="btn-primary" onclick="cerrarYLimpiar()">Continuar Comprando</button>
                </div>
            </div>
        </div>
    </div>

    <div id="productoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productoModalTitle">Agregar Producto</h2>
                <button class="close-btn" onclick="cerrarModalProducto()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productoForm" onsubmit="guardarProducto(event)">
                    <input type="hidden" id="productoId">
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="productoNombre" required>
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="productoMarca" required>
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="productoCategoria" required>
                           <option value="">Cargando categor√≠as...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripcion</label>
                        <textarea id="productoDescripcion" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Precio (S/)</label>
                        <input type="number" id="productoPrecio" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Imagen del Producto</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button type="button" class="btn-upload" onclick="document.getElementById('imageFile').click()">
                                üì§ Subir Imagen
                            </button>
                            <input type="file" id="imageFile" accept="image/*" style="display:none;" onchange="subirImagenCloudinary(event)">
                            <input type="url" id="productoImagen" placeholder="O pega URL de imagen" style="flex: 1;" oninput="previewImagen()">
                        </div>
                        <div class="form-hint">Sube una imagen desde tu dispositivo o pega una URL externa</div>
                        <div class="image-preview" id="imagePreview">
                            <span class="image-preview-text">üñºÔ∏è</span>
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="upload-progress-bar" id="uploadProgressBar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Icono (Emoji) - Se usa si no hay imagen</label>
                        <input type="text" id="productoIcon" maxlength="2" placeholder="üì±">
                    </div>
                    <div class="form-group">
                        <label>Etiqueta (Opcional)</label>
                        <input type="text" id="productoBadge" placeholder="Nuevo, Popular, Oferta...">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productoActivo" checked> Producto activo
                        </label>
                    </div>
                    <div class="variantes-container">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label style="margin: 0;">Variantes (ej: Talla, Color)</label>
                            <button type="button" class="btn-secondary" style="padding: 0.5rem 1rem;" onclick="agregarTipoVariante()">+ Agregar tipo</button>
                        </div>
                         <div class="form-hint">A√±ade opciones para tu producto. Los clientes deber√°n elegir una de cada tipo.</div>
                        <div id="variantesContainer"></div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 1.5rem;">Guardar Producto</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="categoriaModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="categoriaModalTitle">Agregar Categor√≠a</h2>
                <button class="close-btn" onclick="cerrarModalCategoria()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoriaForm" onsubmit="guardarCategoria(event)">
                    <input type="hidden" id="categoriaId">
                    <div class="form-group">
                        <label for="categoriaNombre">Nombre de la Categor√≠a</label>
                        <input type="text" id="categoriaNombre" oninput="generarSlug(this.value)" required>
                        <div class="form-hint">Ej: Smartphones & Tablets</div>
                    </div>
                    <div class="form-group">
                        <label for="categoriaSlug">Slug (URL)</label>
                        <input type="text" id="categoriaSlug" required>
                        <div class="form-hint">Identificador √∫nico en min√∫sculas y sin espacios. Ej: smartphones-tablets</div>
                    </div>
                    <button type="submit" class="btn-primary">Guardar Categor√≠a</button>
                </form>
            </div>
        </div>
    </div>

    <div id="pedidoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="pedidoModalTitle">Detalles del Pedido</h2>
                <button class="close-btn" onclick="cerrarModalPedido()">&times;</button>
            </div>
            <div class="modal-body" id="pedidoModalBody">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>
    
    <div id="detalleProductoModal" class="modal">
        <div class="modal-content">
            <div class="product-image-modal" id="detalleProductoImagen"></div>
            <div class="modal-body">
                 <button class="close-btn" style="position: absolute; top: 1rem; right: 1rem;" onclick="cerrarModalDetalleProducto()">&times;</button>
                <h2 id="detalleProductoNombre" style="color: var(--primary); font-size: 2rem; margin-bottom: 0.5rem;"></h2>
                <div id="detalleProductoMarca" style="color: var(--text-light); margin-bottom: 0.5rem;"></div>
                <p id="detalleProductoDescripcion" style="margin-bottom: 1.5rem;"></p>
                <div id="detalleProductoVariantes"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                    <span id="detalleProductoPrecio" class="product-price" style="margin: 0; padding: 0;"></span>
                    <button id="btnAgregarDesdeModal" class="add-to-cart-btn" style="width: auto; padding: 1rem 2rem;" onclick="agregarAlCarritoDesdeModal()">Agregar al Carrito</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mapModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mapModalTitle">Ubicaci√≥n de Entrega</h2>
                <button class="close-btn" onclick="cerrarModalMapa()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mapa"></div>
                <div id="mapaActions" style="text-align: right; margin-top: 1rem; display: none;">
                    <button class="btn-primary" onclick="confirmarUbicacionDesdeMapa()">Confirmar Ubicaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-logo">Red51 TECHNOLOGY</div>
        <p>2025 Red51 Technology. Todos los derechos reservados.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const SUPABASE_URL = 'https://zejzrujrspeoszpfbjce.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplanpydWpyc3Blb3N6cGZiamNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MDMyNDMsImV4cCI6MjA3NTE3OTI0M30.UAi4jQ0BH1hphW7OEh4JWP4hdVJ4CmvX6x4CyP2ak-U';
        const CLOUDINARY_CLOUD_NAME = 'dvj68er8s';
        const CLOUDINARY_UPLOAD_PRESET = 'red51_productos';
        
        let carrito = [];
        let supabaseClient = null;
        let categoriaActual = 'todos';
        let productos = [];
        let categorias = [];
        let pedidos = [];
        let usuarioActual = null;
        let configuracion = {};
        let mapa;
        let mapaMarker;
        let onMapaConfirmCallback = null;
        let estadoPedidoActual = 'todos';
        let pedidosChannel = null;
        let productoSeleccionado = null;
        const estadosPosibles = ['pendiente_pago', 'pago_confirmado', 'en_preparacion', 'enviado', 'entregado', 'cancelado'];


        async function inicializarSupabase() {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            await cargarConfiguracion();
            await cargarCategorias();
            await cargarProductos();
            await verificarSesion();
        }

        async function cargarConfiguracion() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient
                    .from('configuracion')
                    .select('clave, valor');
                
                if (error) {
                    console.warn('No se pudo cargar la configuraci√≥n de la tienda:', error.message);
                }

                if (data) {
                    configuracion = data.reduce((acc, curr) => {
                        acc[curr.clave] = curr.valor;
                        return acc;
                    }, {});
                }

                const heroSection = document.getElementById('heroSection');
                if (configuracion.hero_image_url) {
                    heroSection.style.backgroundImage = `url('${configuracion.hero_image_url}')`;
                } else {
                    heroSection.style.background = 'linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%)';
                }
            } catch (error) {
                console.error('Ocurri√≥ un error inesperado al procesar la configuraci√≥n de la tienda:', error.message || error);
            }
        }

        async function cargarCategorias() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient.from('categorias').select('*').order('nombre');
                if (error) {
                    console.warn("Advertencia al cargar categor√≠as:", error.message);
                    categorias = [];
                } else {
                    categorias = data || [];
                }
            } catch (error) {
                console.error("Error inesperado al cargar categor√≠as:", error.message);
                categorias = [];
            } finally {
                renderizarFiltrosCategorias();
                llenarSelectorCategoriasProducto();
            }
        }

        async function verificarSesion() {
            if (!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                usuarioActual = session.user;
                mostrarPanelAdmin();
            }
        }

        async function iniciarSesion(event) {
            event.preventDefault();
            const email = document.getElementById('emailLogin').value;
            const password = document.getElementById('passwordLogin').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                usuarioActual = data.user;
                mostrarPanelAdmin();
            } catch (error) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error al iniciar sesion: ' + error.message;
            }
        }

        function mostrarPanelAdmin() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminEmail').textContent = usuarioActual.email;
            
            cargarPedidos();
            cargarProductosAdmin();
            cargarCategoriasAdmin();
            cargarConfiguracionAdmin();

            mostrarVistaAdmin('pedidos');
            suscribirACambiosPedidos();
        }

        function mostrarVistaAdmin(vista) {
            document.querySelectorAll('.admin-view-content').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(`${vista}View`).style.display = 'block';
            document.getElementById(`navBtn${vista.charAt(0).toUpperCase() + vista.slice(1)}`).classList.add('active');
        }

        function cargarConfiguracionAdmin() {
            const heroInput = document.getElementById('heroImageUrl');
            if (heroInput) heroInput.value = configuracion.hero_image_url || '';
        }

        async function guardarConfiguracion(event) {
            event.preventDefault();
            const btn = document.getElementById('btnGuardarConfig');
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const heroImageUrl = document.getElementById('heroImageUrl').value;

            try {
                const { error } = await supabaseClient
                    .from('configuracion')
                    .upsert({ clave: 'hero_image_url', valor: heroImageUrl }, { onConflict: 'clave' });
                if (error) throw error;
                
                mostrarNotificacion('Configuraci√≥n guardada exitosamente.');
                await cargarConfiguracion();
            } catch (error) {
                alert('Error al guardar: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Guardar Cambios';
            }
        }

        async function cerrarSesion() {
            if (pedidosChannel) {
                supabaseClient.removeChannel(pedidosChannel);
                pedidosChannel = null;
            }
            await supabaseClient.auth.signOut();
            usuarioActual = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            mostrarTienda();
        }

        function mostrarTienda() {
            document.getElementById('tiendaView').style.display = 'block';
            document.getElementById('adminView').style.display = 'none';
        }

        function mostrarAdmin() {
            document.getElementById('tiendaView').style.display = 'none';
            document.getElementById('adminView').style.display = 'block';
            if (usuarioActual) mostrarPanelAdmin();
            else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        }

        async function cargarProductos() {
            if (!supabaseClient) return;
            document.getElementById('loadingProducts').style.display = 'block';
            document.getElementById('productsGrid').innerHTML = '';
            try {
                // SOLUCI√ìN: Cargar productos sin el join autom√°tico
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;
                
                const productosData = data || [];

                // SOLUCI√ìN: Unir manualmente las categor√≠as en el lado del cliente
                productos = productosData.map(p => {
                    const categoria = categorias.find(c => c.id === p.categoria_id);
                    return {
                        ...p,
                        // Replicar la estructura que el resto del c√≥digo espera
                        categorias: categoria ? { nombre: categoria.nombre, slug: categoria.slug } : null 
                    };
                });
                
                if (productos.length === 0) {
                    document.getElementById('productsGrid').innerHTML = 
                        '<div class="empty-cart"><p>No hay productos disponibles. Ve al panel Admin para agregar productos.</p></div>';
                    return;
                }
                
                renderizarProductos();

            } catch (error) {
                document.getElementById('productsGrid').innerHTML = 
                    `<div class="empty-cart"><p>Error al cargar productos: ${error.message}</p><p style="font-size: 0.8rem; color: #999;">Aseg√∫rate de haber ejecutado el script de configuraci√≥n desde la pesta√±a de Ayuda en el panel Admin.</p></div>`;
                productos = [];
            } finally {
                document.getElementById('loadingProducts').style.display = 'none';
            }
        }

        function renderizarFiltrosCategorias() {
            const filterContainer = document.getElementById('categoryFilter');
            filterContainer.innerHTML = `
                <button class="filter-btn ${'todos' === categoriaActual ? 'active' : ''}" onclick="filtrarCategoria('todos')">
                    Todos
                </button>
                ${categorias.map(cat => `
                    <button class="filter-btn ${cat.slug === categoriaActual ? 'active' : ''}" 
                            onclick="filtrarCategoria('${cat.slug}')">
                        ${cat.nombre}
                    </button>
                `).join('')}`;
        }

        function filtrarCategoria(slug) {
            categoriaActual = slug;
            renderizarFiltrosCategorias();
            renderizarProductos();
        }

        function renderizarProductos() {
            const grid = document.getElementById('productsGrid');
            const productosFiltrados = categoriaActual === 'todos' 
                ? productos 
                : productos.filter(p => p.categorias && p.categorias.slug === categoriaActual);
            
            if (productosFiltrados.length === 0) {
                grid.innerHTML = '<div class="empty-cart"><p>No hay productos en esta categoria.</p></div>';
                return;
            }

            grid.innerHTML = productosFiltrados.map(producto => {
                const hasVariants = producto.variantes && Array.isArray(producto.variantes) && producto.variantes.length > 0;
                return `
                <div class="product-card">
                    <div class="product-image">
                        ${producto.imagen_url 
                            ? `<img src="${optimizarImagenUrl(producto.imagen_url)}" alt="${producto.nombre}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                               <span style="display:none">${producto.icon || 'üì¶'}</span>`
                            : `<span>${producto.icon || 'üì¶'}</span>`
                        }
                        ${producto.badge ? `<span class="product-badge">${producto.badge}</span>` : ''}
                    </div>
                    <div class="product-info">
                        <div class="product-category">${producto.categorias ? producto.categorias.nombre : 'Sin Categor√≠a'}</div>
                        <h3 class="product-name">${producto.nombre}</h3>
                        <div class="product-brand">${producto.marca}</div>
                        <p class="product-description">${producto.descripcion}</p>
                        <div class="product-price">S/ ${parseFloat(producto.precio).toFixed(2)}</div>
                        ${hasVariants 
                            ? `<button class="add-to-cart-btn" onclick="abrirModalDetalleProducto(${producto.id})">Ver Opciones</button>`
                            : `<button class="add-to-cart-btn" onclick="agregarAlCarrito(${producto.id})">Agregar al Carrito</button>`
                        }
                    </div>
                </div>
            `}).join('');
        }
        
        // --- Product Detail Modal ---
        function abrirModalDetalleProducto(id) {
            productoSeleccionado = productos.find(p => p.id === id);
            if (!productoSeleccionado) return;

            document.getElementById('detalleProductoImagen').innerHTML = productoSeleccionado.imagen_url 
                ? `<img src="${optimizarImagenUrl(productoSeleccionado.imagen_url, 800)}" alt="${productoSeleccionado.nombre}">`
                : `<span style="font-size: 8rem;">${productoSeleccionado.icon || 'üì¶'}</span>`;
            document.getElementById('detalleProductoNombre').textContent = productoSeleccionado.nombre;
            document.getElementById('detalleProductoMarca').textContent = productoSeleccionado.marca;
            document.getElementById('detalleProductoDescripcion').textContent = productoSeleccionado.descripcion;
            document.getElementById('detalleProductoPrecio').textContent = `S/ ${parseFloat(productoSeleccionado.precio).toFixed(2)}`;

            const variantesContainer = document.getElementById('detalleProductoVariantes');
            variantesContainer.innerHTML = (productoSeleccionado.variantes || []).map(variante => `
                <div class="form-group">
                    <label>${variante.nombre}</label>
                    <select class="variante-select">
                        <option value="">Seleccionar ${variante.nombre}</option>
                        ${(variante.opciones || []).map(opcion => `<option value="${opcion}">${opcion}</option>`).join('')}
                    </select>
                </div>
            `).join('');
            
            document.getElementById('detalleProductoModal').classList.add('show');
        }

        function cerrarModalDetalleProducto() {
            document.getElementById('detalleProductoModal').classList.remove('show');
            productoSeleccionado = null;
        }

        function agregarAlCarritoDesdeModal() {
            const variantesSeleccionadas = {};
            const selects = document.querySelectorAll('#detalleProductoVariantes .variante-select');
            let allSelected = true;

            selects.forEach(select => {
                const label = select.previousElementSibling.textContent;
                if (select.value) {
                    variantesSeleccionadas[label] = select.value;
                } else {
                    allSelected = false;
                }
            });

            if (!allSelected) {
                mostrarNotificacion('‚ö†Ô∏è Por favor, selecciona una opci√≥n para cada variante.');
                return;
            }

            agregarAlCarrito(productoSeleccionado.id, variantesSeleccionadas);
            cerrarModalDetalleProducto();
        }


        // --- Cart Logic ---
        function generarCartId(productoId, variantes) {
            if (!variantes) return productoId.toString();
            const variantString = Object.entries(variantes)
                .sort(([keyA], [keyB]) => keyA.localeCompare(keyB))
                .map(([key, value]) => `${key}:${value}`)
                .join('|');
            return `${productoId}-${variantString}`;
        }

        function agregarAlCarrito(productoId, variantesSeleccionadas = null) {
            const producto = productos.find(p => p.id === productoId);
            const cartId = generarCartId(productoId, variantesSeleccionadas);
            const itemExistente = carrito.find(item => item.cartId === cartId);

            if (itemExistente) {
                itemExistente.cantidad++;
            } else {
                carrito.push({
                    ...producto,
                    cantidad: 1,
                    variantes_seleccionadas: variantesSeleccionadas,
                    cartId: cartId
                });
            }
            actualizarContadorCarrito();
            mostrarNotificacion('‚úÖ Producto agregado al carrito');
        }

        function actualizarContadorCarrito() {
            document.getElementById('cartCount').textContent = carrito.reduce((sum, item) => sum + item.cantidad, 0);
        }

        function abrirCarrito() {
            document.getElementById('cartModal').classList.add('show');
            renderizarCarrito();
        }

        function cerrarCarrito() {
            document.getElementById('cartModal').classList.remove('show');
        }

        function renderizarCarrito() {
            const content = document.getElementById('cartContent');
            document.getElementById('successMessage').style.display = 'none';
            if (carrito.length === 0) {
                content.innerHTML = `<div class="empty-cart"><div class="empty-cart-icon">üõí</div><p>Tu carrito esta vacio</p></div>`;
                return;
            }
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            content.innerHTML = `
                ${carrito.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-icon">${item.icon || 'üì¶'}</div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.nombre}</div>
                             ${item.variantes_seleccionadas ? `<div class="cart-item-variants">${Object.entries(item.variantes_seleccionadas).map(([k, v]) => `${k}: ${v}`).join(', ')}</div>` : ''}
                            <div class="cart-item-brand">${item.marca}</div>
                            <div class="cart-item-price">S/ ${parseFloat(item.precio).toFixed(2)} c/u</div>
                            <div class="cart-item-controls">
                                <button class="qty-btn" onclick="cambiarCantidad('${item.cartId}', -1)">-</button>
                                <span class="qty-display">${item.cantidad}</span>
                                <button class="qty-btn" onclick="cambiarCantidad('${item.cartId}', 1)">+</button>
                                <button class="remove-btn" onclick="eliminarItem('${item.cartId}')">Eliminar</button>
                            </div>
                        </div>
                        <div style="font-weight: 700; font-size: 1.2rem; color: var(--primary);">
                            S/ ${(item.precio * item.cantidad).toFixed(2)}
                        </div>
                    </div>
                `).join('')}
                <div class="cart-total">
                    <span class="cart-total-label">Total:</span>
                    <span class="cart-total-amount">S/ ${total.toFixed(2)}</span>
                </div>
                <form class="checkout-form" onsubmit="realizarPedido(event)">
                    <div class="form-group"><label>Nombre Completo</label><input type="text" id="nombreCliente" required></div>
                    <div class="form-group"><label>Telefono (sin prefijo +51)</label><input type="tel" id="telefonoCliente" required placeholder="905820448"></div>
                    <div class="form-group"><label>Email (Opcional)</label><input type="email" id="emailCliente" placeholder="cliente@ejemplo.com"></div>
                    <div class="form-group">
                        <label>Direccion de Entrega</label>
                        <textarea id="direccionCliente" required></textarea>
                         <input type="hidden" id="latitudCliente"><input type="hidden" id="longitudCliente">
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button type="button" class="btn-secondary" style="font-size: 0.9rem;" onclick="usarUbicacionActual()">üìç Usar mi ubicaci√≥n actual</button>
                            <button type="button" class="btn-secondary" style="font-size: 0.9rem;" onclick="seleccionarUbicacionEnMapa()">üó∫Ô∏è Seleccionar en el mapa</button>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="btnRealizarPedido">Realizar Pedido</button>
                </form>`;
        }

        function cambiarCantidad(cartId, cambio) {
            const itemIndex = carrito.findIndex(item => item.cartId === cartId);
            if (itemIndex === -1) return;

            carrito[itemIndex].cantidad += cambio;
            if (carrito[itemIndex].cantidad <= 0) carrito.splice(itemIndex, 1);
            
            actualizarContadorCarrito();
            renderizarCarrito();
        }

        function eliminarItem(cartId) {
            carrito = carrito.filter(item => item.cartId !== cartId);
            actualizarContadorCarrito();
            renderizarCarrito();
        }
        
        async function geocodeDireccion(direccion) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`);
                if (!response.ok) throw new Error('Servicio de geocodificaci√≥n no disponible');
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                }
                return null;
            } catch (error) {
                console.warn("No se pudo geocodificar la direcci√≥n:", error.message);
                return null;
            }
        }
        
        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                if (!response.ok) throw new Error('Servicio de geocodificaci√≥n no disponible');
                const data = await response.json();
                return data.display_name || `${lat}, ${lon}`;
            } catch (error) {
                console.warn("No se pudo obtener la direcci√≥n:", error.message);
                return "No se pudo obtener la direcci√≥n.";
            }
        }

        function usarUbicacionActual() {
            if (!navigator.geolocation) return alert('La geolocalizaci√≥n no est√° soportada por tu navegador.');
            
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                document.getElementById('latitudCliente').value = latitude;
                document.getElementById('longitudCliente').value = longitude;
                const direccion = await reverseGeocode(latitude, longitude);
                document.getElementById('direccionCliente').value = direccion;
                mostrarNotificacion('üìç Ubicaci√≥n actual obtenida.');
            }, (error) => {
                alert('No se pudo obtener tu ubicaci√≥n. Aseg√∫rate de dar los permisos necesarios.');
            });
        }

        function seleccionarUbicacionEnMapa() {
            abrirModalMapa(null, null, 'Selecciona la direcci√≥n de entrega', true, (lat, lon) => {
                document.getElementById('latitudCliente').value = lat;
                document.getElementById('longitudCliente').value = lon;
                reverseGeocode(lat, lon).then(direccion => {
                    document.getElementById('direccionCliente').value = direccion;
                });
                cerrarModalMapa();
            });
        }


        async function realizarPedido(event) {
            event.preventDefault();
            const btnPedido = document.getElementById('btnRealizarPedido');
            btnPedido.disabled = true;
            btnPedido.textContent = 'Procesando pedido...';
            
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            const cantidad = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            const direccion = document.getElementById('direccionCliente').value;
            let latitud = document.getElementById('latitudCliente').value;
            let longitud = document.getElementById('longitudCliente').value;

            if (!latitud || !longitud) {
                const coords = await geocodeDireccion(direccion);
                if (coords) {
                    latitud = coords.lat;
                    longitud = coords.lon;
                }
            }

            const pedidoData = {
                nombre_cliente: document.getElementById('nombreCliente').value,
                telefono_cliente: document.getElementById('telefonoCliente').value,
                email_cliente: document.getElementById('emailCliente').value || null,
                direccion: direccion,
                productos: carrito.map(item => ({
                    id: item.id,
                    producto: item.nombre, 
                    marca: item.marca, 
                    cantidad: item.cantidad,
                    precio_unitario: parseFloat(item.precio),
                    subtotal: parseFloat(item.precio) * item.cantidad,
                    variantes: item.variantes_seleccionadas
                })),
                total: parseFloat(total),
                cantidad_items: cantidad,
                estado: 'pendiente_pago',
                latitud: latitud ? parseFloat(latitud) : null,
                longitud: longitud ? parseFloat(longitud) : null,
            };
            
            try {
                const { data: pedidoGuardado, error } = await supabaseClient
                    .from('pedidos')
                    .insert([pedidoData])
                    .select()
                    .single();

                if (error) throw error;
                
                try {
                    await fetch('https://webhook.red51.site/webhook/pedidos_red51', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pedidoGuardado)
                    });
                } catch (webhookError) {
                    console.warn('El pedido se guard√≥, pero fall√≥ el env√≠o al webhook:', webhookError.message);
                }

                document.getElementById('cartContent').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';

            } catch (error) {
                alert('Error al realizar el pedido: ' + error.message);
                btnPedido.disabled = false;
                btnPedido.textContent = 'Realizar Pedido';
            }
        }

        function cerrarYLimpiar() {
            carrito = [];
            actualizarContadorCarrito();
            cerrarCarrito();
            document.getElementById('cartContent').style.display = 'block';
        }
        
        // --- ADMIN: Pedidos ---
        async function cargarPedidos() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient
                    .from('pedidos')
                    .select('*')
                    .order('fecha_pedido', { ascending: false });
                
                if (error) throw error;
                pedidos = data || [];
                renderizarFiltroEstados();
                renderizarPedidos();
            } catch (error) {
                console.error("Error al cargar pedidos:", error.message);
            }
        }

        function renderizarFiltroEstados() {
            const container = document.getElementById('pedidosFilterContainer');
            const estados = ['todos', ...estadosPosibles];
            container.innerHTML = estados.map(e => `
                <button class="filter-btn ${e === estadoPedidoActual ? 'active' : ''}" onclick="filtrarPedidosPorEstado('${e}')">
                    ${(e.charAt(0).toUpperCase() + e.slice(1)).replace(/_/g, ' ')}
                </button>
            `).join('');
        }

        function filtrarPedidosPorEstado(estado) {
            estadoPedidoActual = estado;
            renderizarFiltroEstados();
            renderizarPedidos();
        }

        function renderizarPedidos() {
            const pedidosFiltrados = estadoPedidoActual === 'todos'
                ? pedidos
                : pedidos.filter(p => p.estado === estadoPedidoActual);

            const ingresosTotales = pedidosFiltrados.reduce((sum, p) => sum + parseFloat(p.total), 0);
            const pedidosPendientes = pedidos.filter(p => p.estado === 'pendiente_pago' || p.estado === 'pago_confirmado' || p.estado === 'en_preparacion').length;
            
            document.getElementById('kpiIngresos').textContent = `S/ ${ingresosTotales.toFixed(2)}`;
            document.getElementById('kpiTotalPedidos').textContent = pedidos.length;
            document.getElementById('kpiPendientes').textContent = pedidosPendientes;

            const tbody = document.getElementById('adminPedidosTable');
            if(pedidosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 2rem;">No hay pedidos con este estado.</td></tr>`;
                return;
            }
            tbody.innerHTML = pedidosFiltrados.map(p => `
                <tr data-id="${p.id}" onclick="verDetallesPedido('${p.id}')">
                    <td>${p.numero_pedido || 'N/A'}</td>
                    <td>${new Date(p.fecha_pedido).toLocaleDateString()}</td>
                    <td>${p.nombre_cliente}</td>
                    <td>S/ ${parseFloat(p.total).toFixed(2)}</td>
                    <td onclick="event.stopPropagation()">
                         <select class="status-select ${p.estado}" onchange="cambiarEstadoPedido('${p.id}', this.value)">
                            ${estadosPosibles.map(e => `<option value="${e}" ${e === p.estado ? 'selected' : ''}>${e.replace(/_/g, ' ')}</option>`).join('')}
                        </select>
                    </td>
                    <td onclick="event.stopPropagation()" style="text-align: center;">
                        ${p.latitud && p.longitud ? `
                            <button class="btn-secondary" style="padding: 0.5rem; font-size: 1.2rem; line-height: 1;" onclick="abrirModalMapa(${p.latitud}, ${p.longitud}, 'Ubicaci√≥n para: ${p.nombre_cliente}')">üó∫Ô∏è</button>
                        ` : `<span>-</span>`}
                    </td>
                </tr>
            `).join('');
        }

        async function verDetallesPedido(pedidoId) {
            try {
                const pedido = pedidos.find(p => p.id === pedidoId);
                if (!pedido) throw new Error('Pedido no encontrado');
                
                const modalBody = document.getElementById('pedidoModalBody');

                modalBody.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; flex-wrap: wrap;">
                        <div>
                            <h4>Datos del Cliente</h4>
                            <p><strong>Nombre:</strong> ${pedido.nombre_cliente}</p>
                            <p><strong>Tel√©fono:</strong> ${pedido.telefono_cliente}</p>
                            <p><strong>Email:</strong> ${pedido.email_cliente || 'No provisto'}</p>
                            <p><strong>Direcci√≥n:</strong> ${pedido.direccion}</p>
                        </div>
                        <div>
                            <h4>Resumen del Pedido</h4>
                            <p><strong>N¬∞ Pedido:</strong> ${pedido.numero_pedido || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${new Date(pedido.fecha_pedido).toLocaleString()}</p>
                            <p><strong>Total:</strong> S/ ${parseFloat(pedido.total).toFixed(2)}</p>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label style="color: var(--text-dark);">Cambiar Estado</label>
                                <select id="modalStatusSelect" class="status-select ${pedido.estado}" onchange="cambiarEstadoPedido('${pedido.id}', this.value)">
                                    ${estadosPosibles.map(e => `<option value="${e}" ${e === pedido.estado ? 'selected' : ''}>${e.replace(/_/g, ' ')}</option>`).join('')}
                                </select>
                            </div>
                            ${pedido.latitud && pedido.longitud ? `
                                <div style="display: flex; gap: 0.5rem; width: 100%; margin-top: 1rem;">
                                    <button class="btn-secondary" style="flex: 1;" onclick="abrirModalMapa(${pedido.latitud}, ${pedido.longitud}, 'Ubicaci√≥n para: ${pedido.nombre_cliente}')">üó∫Ô∏è Ver en Mapa</button>
                                    <a href="https://maps.google.com/?q=${pedido.latitud},${pedido.longitud}" target="_blank" class="btn-secondary" style="flex: 1; text-align:center; text-decoration: none;">‚ÜóÔ∏è Abrir en GMaps</a>
                                </div>
                            ` : '<p style="margin-top: 1rem; color: var(--text-light);">Ubicaci√≥n no disponible.</p>'}
                        </div>
                    </div>
                    <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Productos</h4>
                    ${(pedido.productos || []).map(p => {
                        const variantesStr = p.variantes ? ` <span class="cart-item-variants">${Object.entries(p.variantes).map(([k, v]) => `${k}: ${v}`).join(', ')}</span>` : '';
                        return `
                        <div class="cart-item" style="padding: 1rem;">
                           <div class="cart-item-info">
                                <div class="cart-item-name">${p.producto} (x${p.cantidad})</div>
                                <div class="cart-item-brand">${p.marca}</div>
                                ${variantesStr}
                           </div>
                           <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">
                                S/ ${parseFloat(p.subtotal).toFixed(2)}
                           </div>
                        </div>
                    `}).join('')}
                `;
                document.getElementById('pedidoModal').classList.add('show');

            } catch (error) {
                alert("Error al cargar detalles del pedido: " + error.message);
            }
        }

        function cerrarModalPedido() {
             document.getElementById('pedidoModal').classList.remove('show');
        }

        async function cambiarEstadoPedido(pedidoId, nuevoEstado) {
            try {
                 const { error } = await supabaseClient
                    .from('pedidos')
                    .update({ estado: nuevoEstado })
                    .eq('id', pedidoId);
                
                if (error) throw error;
                
                mostrarNotificacion(`‚úÖ Estado del pedido actualizado`);
                const pedidoIndex = pedidos.findIndex(p => p.id === pedidoId);
                if (pedidoIndex !== -1) {
                    pedidos[pedidoIndex].estado = nuevoEstado;
                }
                renderizarPedidos();

                const modalSelect = document.getElementById('modalStatusSelect');
                if (modalSelect) {
                    modalSelect.className = `status-select ${nuevoEstado}`;
                    modalSelect.value = nuevoEstado;
                }

            } catch(error) {
                alert("Error al actualizar el estado: " + error.message);
            }
        }

        function suscribirACambiosPedidos() {
            if (pedidosChannel) {
                supabaseClient.removeChannel(pedidosChannel);
            }
            pedidosChannel = supabaseClient
                .channel('pedidos-db-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'pedidos' },
                    (payload) => {
                        console.log('Cambio recibido en pedidos!', payload);
                        const changedRecord = payload.new;
                        const index = pedidos.findIndex(p => p.id === changedRecord.id);

                        if (payload.eventType === 'DELETE') {
                           if(index !== -1) pedidos.splice(index, 1);
                        } else if (index !== -1) {
                            pedidos[index] = { ...pedidos[index], ...changedRecord };
                        } else {
                            pedidos.unshift(changedRecord); // Add new orders to the top
                        }
                        
                        renderizarPedidos();
                        
                        setTimeout(() => {
                            const updatedRow = document.querySelector(`tr[data-id="${changedRecord.id}"]`);
                            if (updatedRow && payload.eventType !== 'DELETE') {
                                updatedRow.classList.add('row-updated');
                                setTimeout(() => updatedRow.classList.remove('row-updated'), 3000);
                            }
                        }, 0);
                    }
                )
                .subscribe();
        }

        function abrirModalMapa(lat, lon, title, isInteractive = false, onConfirm = null) {
            document.getElementById('mapModalTitle').textContent = title || 'Ubicaci√≥n de Entrega';
            document.getElementById('mapModal').classList.add('show');
            
            onMapaConfirmCallback = onConfirm;
            document.getElementById('mapaActions').style.display = isInteractive ? 'block' : 'none';
            
            setTimeout(() => {
                if (mapa) mapa.remove();
                
                const initialCoords = (lat && lon) ? [lat, lon] : [-12.046374, -77.042793]; // Default to Lima, Peru
                mapa = L.map('mapa').setView(initialCoords, 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }).addTo(mapa);

                mapaMarker = L.marker(initialCoords, { draggable: isInteractive }).addTo(mapa);
                if (!isInteractive) {
                     mapaMarker.bindPopup(`<b>Entrega para:</b><br>${title.replace('Ubicaci√≥n para: ','')}`).openPopup();
                }
            }, 100);
        }

        function confirmarUbicacionDesdeMapa() {
            if (onMapaConfirmCallback && mapaMarker) {
                const { lat, lng } = mapaMarker.getLatLng();
                onMapaConfirmCallback(lat, lng);
            }
        }

        function cerrarModalMapa() {
            document.getElementById('mapModal').classList.remove('show');
            if (mapa) {
                mapa.remove();
                mapa = null;
                mapaMarker = null;
                onMapaConfirmCallback = null;
            }
        }


        // --- ADMIN: Productos y Categor√≠as ---
        async function cargarProductosAdmin() {
            if (!supabaseClient) return;
            document.getElementById('loadingAdmin').style.display = 'block';
            try {
                // SOLUCI√ìN: Cargar productos sin el join autom√°tico
                const { data, error } = await supabaseClient.from('productos').select('*').order('nombre');
                if (error) throw error;
                
                const productosAdminData = data || [];

                // SOLUCI√ìN: Unir manualmente las categor√≠as en el lado del cliente
                const productosAdmin = productosAdminData.map(p => {
                    const categoria = categorias.find(c => c.id === p.categoria_id);
                    return {
                        ...p,
                        categorias: categoria ? { nombre: categoria.nombre } : null
                    };
                });

                const tbody = document.getElementById('adminProductsTable');
                tbody.innerHTML = productosAdmin.map(p => `
                    <tr style="cursor: default;">
                        <td>${p.imagen_url ? `<img src="${optimizarImagenUrl(p.imagen_url, 50)}" alt="${p.nombre}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'">` : '<span style="font-size: 0.8rem; color: #999;">Sin imagen</span>'}</td>
                        <td>${p.nombre}</td>
                        <td>${p.categorias ? p.categorias.nombre : 'Sin categor√≠a'}</td>
                        <td>S/ ${parseFloat(p.precio).toFixed(2)}</td>
                        <td>${p.variantes && p.variantes.length > 0 ? `${p.variantes.length} tipo(s)` : 'No'}</td>
                        <td>${p.activo ? 'Activo' : 'Inactivo'}</td>
                        <td class="table-actions">
                            <button class="btn-edit" onclick="editarProducto(${p.id}, event)">Editar</button>
                            <button class="btn-danger" onclick="eliminarProducto(${p.id}, event)">Eliminar</button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                alert('Error al cargar productos: ' + error.message);
            } finally {
                document.getElementById('loadingAdmin').style.display = 'none';
            }
        }
        
        async function cargarCategoriasAdmin() {
            if(!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient.from('categorias').select('*').order('nombre');
                if (error) throw error;
                const tbody = document.getElementById('adminCategoriesTable');
                tbody.innerHTML = (data || []).map(cat => `
                    <tr style="cursor: default;">
                        <td>${cat.nombre}</td>
                        <td>${cat.slug}</td>
                        <td class="table-actions">
                            <button class="btn-edit" onclick="editarCategoria(${cat.id}, event)">Editar</button>
                            <button class="btn-danger" onclick="eliminarCategoria(${cat.id}, event)">Eliminar</button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                alert('Error al cargar categor√≠as: ' + error.message);
            }
        }

        function abrirModalCategoria() {
            document.getElementById('categoriaModalTitle').textContent = 'Agregar Categor√≠a';
            document.getElementById('categoriaForm').reset();
            document.getElementById('categoriaId').value = '';
            document.getElementById('categoriaModal').classList.add('show');
        }

        function cerrarModalCategoria() {
            document.getElementById('categoriaModal').classList.remove('show');
        }

        async function editarCategoria(id, event) {
            event.stopPropagation();
            try {
                const { data, error } = await supabaseClient.from('categorias').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('categoriaModalTitle').textContent = 'Editar Categor√≠a';
                document.getElementById('categoriaId').value = data.id;
                document.getElementById('categoriaNombre').value = data.nombre;
                document.getElementById('categoriaSlug').value = data.slug;
                document.getElementById('categoriaModal').classList.add('show');
            } catch (error) {
                alert('Error al cargar categor√≠a: ' + error.message);
            }
        }

        async function guardarCategoria(event) {
            event.preventDefault();
            const id = document.getElementById('categoriaId').value;
            const categoria = {
                nombre: document.getElementById('categoriaNombre').value,
                slug: document.getElementById('categoriaSlug').value,
            };

            try {
                if (id) {
                    const { error } = await supabaseClient.from('categorias').update(categoria).eq('id', id);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Categor√≠a actualizada');
                } else {
                    const { error } = await supabaseClient.from('categorias').insert([categoria]);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Categor√≠a creada');
                }
                cerrarModalCategoria();
                await cargarCategorias();
                cargarCategoriasAdmin();
            } catch (error) {
                alert('Error al guardar categor√≠a: ' + error.message);
            }
        }

        async function eliminarCategoria(id, event) {
            event.stopPropagation();
            if (!confirm('¬øEst√°s seguro? Eliminar una categor√≠a fallar√° si todav√≠a hay productos en ella.')) return;
            try {
                const { error } = await supabaseClient.from('categorias').delete().eq('id', id);
                if (error) throw error;
                mostrarNotificacion('üóëÔ∏è Categor√≠a eliminada');
                await cargarCategorias();
                cargarCategoriasAdmin();
            } catch (error) {
                alert('Error al eliminar categor√≠a: ' + error.message);
            }
        }

        function generarSlug(text) {
            const slug = text.toString().toLowerCase()
                .replace(/\s+/g, '-') 
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-') 
                .replace(/^-+/, '') 
                .replace(/-+$/, ''); 
            document.getElementById('categoriaSlug').value = slug;
        }

        function llenarSelectorCategoriasProducto() {
            const select = document.getElementById('productoCategoria');
            if (!select) return;
            if (categorias.length === 0) {
                select.innerHTML = '<option value="">Crea una categor√≠a primero</option>';
            } else {
                select.innerHTML = '<option value="">-- Selecciona --</option>' + categorias.map(cat => `<option value="${cat.id}">${cat.nombre}</option>`).join('');
            }
        }

        async function abrirModalProducto() {
            document.getElementById('productoModalTitle').textContent = 'Agregar Producto';
            document.getElementById('productoForm').reset();
            document.getElementById('productoId').value = '';
            document.getElementById('productoActivo').checked = true;
            document.getElementById('imagePreview').innerHTML = '<span class="image-preview-text">üñºÔ∏è</span>';
            document.getElementById('variantesContainer').innerHTML = '';
            llenarSelectorCategoriasProducto();
            document.getElementById('productoModal').classList.add('show');
        }

        function cerrarModalProducto() {
            document.getElementById('productoModal').classList.remove('show');
        }

        async function editarProducto(id, event) {
            event.stopPropagation();
            try {
                const { data, error } = await supabaseClient.from('productos').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('productoModalTitle').textContent = 'Editar Producto';
                document.getElementById('productoId').value = data.id;
                document.getElementById('productoNombre').value = data.nombre;
                document.getElementById('productoMarca').value = data.marca;
                document.getElementById('productoDescripcion').value = data.descripcion;
                document.getElementById('productoPrecio').value = data.precio;
                document.getElementById('productoIcon').value = data.icon || '';
                document.getElementById('productoBadge').value = data.badge || '';
                document.getElementById('productoActivo').checked = data.activo;
                document.getElementById('productoImagen').value = data.imagen_url || '';
                
                llenarSelectorCategoriasProducto();
                document.getElementById('productoCategoria').value = data.categoria_id;
                
                renderizarVariantesForm(data.variantes);
                previewImagen();
                document.getElementById('productoModal').classList.add('show');
            } catch (error) {
                alert('Error al cargar producto: ' + error.message);
            }
        }
        
        function agregarTipoVariante() {
            const container = document.getElementById('variantesContainer');
            const newIndex = container.children.length;
            const div = document.createElement('div');
            div.className = 'variante-group';
            div.innerHTML = `
                <div class="variante-header">
                    <input type="text" placeholder="Nombre de la Variante (ej: Color)" class="variante-nombre form-group" style="margin:0;">
                    <button type="button" class="btn-danger" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
                <div class="opciones-container">
                    <input type="text" placeholder="A√±adir opci√≥n..." onkeydown="agregarOpcionVariante(event)">
                </div>
                <div class="form-hint">Escribe una opci√≥n y presiona Enter para agregarla.</div>
            `;
            container.appendChild(div);
        }

        function agregarOpcionVariante(event) {
            if (event.key !== 'Enter') return;
            event.preventDefault();
            const input = event.target;
            const valor = input.value.trim();
            if (!valor) return;

            const tag = document.createElement('span');
            tag.className = 'opcion-tag';
            tag.innerHTML = `
                ${valor}
                <button type="button" onclick="this.parentElement.remove()">√ó</button>
            `;
            input.parentElement.insertBefore(tag, input);
            input.value = '';
        }

        function renderizarVariantesForm(variantes) {
            const container = document.getElementById('variantesContainer');
            container.innerHTML = '';
            if (!variantes || !Array.isArray(variantes)) return;

            variantes.forEach(variante => {
                const div = document.createElement('div');
                div.className = 'variante-group';
                let opcionesHTML = (variante.opciones || []).map(opcion => `
                    <span class="opcion-tag">
                        ${opcion}
                        <button type="button" onclick="this.parentElement.remove()">√ó</button>
                    </span>
                `).join('');

                div.innerHTML = `
                    <div class="variante-header">
                        <input type="text" placeholder="Nombre de la Variante" class="variante-nombre form-group" style="margin:0;" value="${variante.nombre || ''}">
                        <button type="button" class="btn-danger" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <div class="opciones-container">
                        ${opcionesHTML}
                        <input type="text" placeholder="A√±adir opci√≥n..." onkeydown="agregarOpcionVariante(event)">
                    </div>
                    <div class="form-hint">Escribe una opci√≥n y presiona Enter para agregarla.</div>
                `;
                container.appendChild(div);
            });
        }

        function serializarVariantes() {
            const container = document.getElementById('variantesContainer');
            const variantes = [];
            container.querySelectorAll('.variante-group').forEach(group => {
                const nombre = group.querySelector('.variante-nombre').value.trim();
                if (!nombre) return;
                const opciones = [];
                group.querySelectorAll('.opcion-tag').forEach(tag => {
                    opciones.push(tag.textContent.trim().slice(0, -1).trim());
                });
                if (opciones.length > 0) {
                    variantes.push({ nombre, opciones });
                }
            });
            return variantes.length > 0 ? variantes : null;
        }

        async function guardarProducto(event) {
            event.preventDefault();
            const id = document.getElementById('productoId').value;
            const categoriaIdValue = document.getElementById('productoCategoria').value;

            const producto = {
                nombre: document.getElementById('productoNombre').value,
                marca: document.getElementById('productoMarca').value,
                categoria_id: categoriaIdValue ? parseInt(categoriaIdValue) : null,
                descripcion: document.getElementById('productoDescripcion').value,
                precio: parseFloat(document.getElementById('productoPrecio').value),
                icon: document.getElementById('productoIcon').value || 'üì¶',
                badge: document.getElementById('productoBadge').value || null,
                activo: document.getElementById('productoActivo').checked,
                imagen_url: document.getElementById('productoImagen').value || null,
                variantes: serializarVariantes(),
            };

            try {
                if (id) {
                    const { error } = await supabaseClient.from('productos').update(producto).eq('id', id);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Producto actualizado exitosamente');
                } else {
                    const { error } = await supabaseClient.from('productos').insert([producto]);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Producto creado exitosamente');
                }
                cerrarModalProducto();
                await cargarProductosAdmin();
                await cargarProductos(); // Recargar productos de la tienda tambi√©n
            } catch (error) {
                alert('Error al guardar producto: ' + error.message);
            }
        }

        async function eliminarProducto(id, event) {
            event.stopPropagation();
            if (!confirm('Estas seguro de eliminar este producto?')) return;
            try {
                const { error } = await supabaseClient.from('productos').delete().eq('id', id);
                if (error) throw error;
                mostrarNotificacion('üóëÔ∏è Producto eliminado exitosamente');
                await cargarProductosAdmin();
                await cargarProductos(); // Recargar productos de la tienda tambi√©n
            } catch (error) {
                alert('Error al eliminar producto: ' + error.message);
            }
        }

        function previewImagen() {
            const imagenUrl = document.getElementById('productoImagen').value;
            const preview = document.getElementById('imagePreview');
            if (imagenUrl) {
                const urlOptimizada = optimizarImagenUrl(imagenUrl);
                preview.innerHTML = `<img src="${urlOptimizada}" alt="Preview" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'image-preview-text\'>‚ùå</span>'">`;
            } else {
                preview.innerHTML = '<span class="image-preview-text">üñºÔ∏è</span>';
            }
        }

        async function subirImagenCloudinary(event) {
            const file = event.target.files[0];
            if (!file) return;

            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('uploadProgressBar');
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Error al subir la imagen');
                const data = await response.json();
                progressFill.style.width = '100%';
                
                document.getElementById('productoImagen').value = data.secure_url;
                previewImagen();
                
                mostrarNotificacion('üñºÔ∏è Imagen subida');
                setTimeout(() => { progressBar.style.display = 'none'; }, 1000);
            } catch (error) {
                alert('Error al subir la imagen: ' + error.message);
                progressBar.style.display = 'none';
            }
        }

        function optimizarImagenUrl(url, width = 600) {
            if (url && url.includes('res.cloudinary.com') && !url.includes('/upload/c_')) {
                const parts = url.split('/upload/');
                if (parts.length === 2) {
                    return `${parts[0]}/upload/c_fill,g_auto,q_auto,f_auto,w_${width}/${parts[1]}`;
                }
            }
            return url;
        }

        function descargarPlantilla() {
            const csvContent = `nombre,marca,categoria_id,descripcion,precio,icon,badge,imagen_url,activo\niPhone 15 Pro,Apple,1,Smartphone premium,4599.00,üì±,Nuevo,https://ejemplo.com/iphone15.jpg,true`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'plantilla_productos_red51.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            mostrarNotificacion('üì• Plantilla CSV descargada.');
        }

        async function importarProductos(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const productosImportados = lines.slice(1).map(line => {
                        if (!line.trim()) return null;
                        const values = line.split(',').map(v => v.trim());
                        const producto = {};
                        headers.forEach((header, i) => {
                            if (header === 'categoria_id' || header === 'precio') {
                                producto[header] = parseFloat(values[i]);
                            } else if (header === 'activo') {
                                producto[header] = values[i]?.toLowerCase() === 'true';
                            } else {
                                producto[header] = values[i] || null;
                            }
                        });
                        return producto;
                    }).filter(p => p && p.nombre && p.marca && p.categoria_id && p.precio);
                    
                    if (productosImportados.length === 0) return alert('No se encontraron productos v√°lidos en el CSV');
                    if (!confirm(`Se importar√°n ${productosImportados.length} productos. ¬øContinuar?`)) return;
                    
                    document.getElementById('loadingAdmin').style.display = 'block';
                    const { error } = await supabaseClient.from('productos').insert(productosImportados);
                    if (error) throw error;
                    
                    mostrarNotificacion(`‚úÖ ${productosImportados.length} productos importados`);
                    cargarProductosAdmin();
                    cargarProductos();
                } catch (error) {
                    alert('Error al importar productos: ' + error.message);
                } finally {
                    document.getElementById('loadingAdmin').style.display = 'none';
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function mostrarNotificacion(mensaje) {
            const notif = document.createElement('div');
            notif.textContent = mensaje;
            notif.style.cssText = `position: fixed; top: 100px; right: 20px; background: var(--dark); color: white; padding: 1rem 2rem; border-radius: 10px; box-shadow: var(--shadow-lg); z-index: 10000; font-weight: 600; animation: fadeInOut 3s ease-in-out forwards;`;
            const style = document.createElement('style');
            style.id = 'notif-style';
            if (!document.getElementById('notif-style')) {
                style.innerHTML = `@keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-20px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }`;
                document.head.appendChild(style);
            }
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('cartModal')) cerrarCarrito();
            if (event.target == document.getElementById('productoModal')) cerrarModalProducto();
            if (event.target == document.getElementById('categoriaModal')) cerrarModalCategoria();
            if (event.target == document.getElementById('pedidoModal')) cerrarModalPedido();
            if (event.target == document.getElementById('mapModal')) cerrarModalMapa();
            if (event.target == document.getElementById('detalleProductoModal')) cerrarModalDetalleProducto();
        }

        inicializarSupabase();
    </script>
</body>
</html>